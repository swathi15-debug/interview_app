<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Interview Assistant</title>
  <style>
    /* your full CSS unchanged */
  </style>
</head>
<body>
  <div class="container">
    <!-- your UI unchanged (upload, chat, feedback, etc.) -->
  </div>

  <script>
    let interviewData = {
      sessionId: null,   // ðŸ”‘ will hold session_id from backend
      resumeContent: '',
      jdContent: '',
      conversationHistory: [],
      currentQuestion: 0,
      totalQuestions: 8,
      interviewStarted: false
    };

    const WEBHOOK_URL = "https://swathigude.app.n8n.cloud/webhook/interview-webhook1";

    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      setTimeout(() => errorDiv.style.display = 'none', 5000);
    }

    async function startInterview() {
      const resumeFile = document.getElementById('resumeFile').files[0];
      const jdFile = document.getElementById('jdFile').files[0];

      if (!resumeFile || !jdFile) {
        showError("Please upload both resume and job description files.");
        return;
      }

      showLoading(true);
      updateProgress(20);

      try {
        const formData = new FormData();
        formData.append("action", "start_interview");
        formData.append("resume", resumeFile);
        formData.append("jobDescription", jdFile);

        const response = await fetch(WEBHOOK_URL, {
          method: "POST",
          body: formData
        });

        updateProgress(60);
        const data = await response.json();
        console.log("Interview start response:", data);

        if (!data.success) throw new Error(data.message || "Failed to start interview");

        // ðŸ”‘ Save session_id globally
        interviewData.sessionId = data.session_id;
        localStorage.setItem("sessionId", data.session_id);

        interviewData.interviewStarted = true;
        updateProgress(100);
        showLoading(false);

        document.getElementById("uploadSection").style.display = "none";
        document.getElementById("chatSection").style.display = "block";

        if (data.firstQuestion) {
          addMessage(data.firstQuestion, "ai");
          interviewData.currentQuestion = 1;
          updateProgress((interviewData.currentQuestion / interviewData.totalQuestions) * 100);
        }

      } catch (err) {
        console.error("Error starting interview:", err);
        showError(err.message);
        showLoading(false);
      }
    }

    async function sendMessage() {
      const input = document.getElementById("chatInput");
      const message = input.value.trim();
      if (!message) return;

      addMessage(message, "user");
      input.value = "";

      interviewData.conversationHistory.push({
        role: "user",
        content: message,
        timestamp: new Date().toISOString()
      });

      showTyping(true);

      try {
        const shouldContinue = interviewData.currentQuestion < interviewData.totalQuestions;

        const body = {
          action: shouldContinue ? "continue_interview" : "generate_feedback",
          session_id: interviewData.sessionId,  // ðŸ”‘ Always include saved session_id
          userResponse: message,
          conversationHistory: interviewData.conversationHistory,
          questionCount: interviewData.currentQuestion
        };

        const response = await fetch(WEBHOOK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        const data = await response.json();
        showTyping(false);
        console.log("Answer response:", data);

        if (!data.success) throw new Error(data.message || "Failed to process answer");

        if (shouldContinue && data.nextQuestion) {
          setTimeout(() => {
            addMessage(data.nextQuestion, "ai");
            interviewData.currentQuestion++;
            updateProgress((interviewData.currentQuestion / interviewData.totalQuestions) * 100);
            interviewData.conversationHistory.push({
              role: "assistant",
              content: data.nextQuestion,
              timestamp: new Date().toISOString()
            });
          }, 1000);
        } else {
          addMessage("Thank you for completing the interview! Generating feedback...", "ai");
          setTimeout(() => generateFinalFeedback(), 2000);
        }
      } catch (err) {
        showTyping(false);
        showError(err.message);
        addMessage("Sorry, I couldn't process that. Please try again.", "ai");
      }
    }

    async function generateFinalFeedback() {
      try {
        const response = await fetch(WEBHOOK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "generate_feedback",
            session_id: interviewData.sessionId, // ðŸ”‘ still sending
            conversationHistory: interviewData.conversationHistory
          })
        });
        const data = await response.json();
        if (data.success) {
          document.getElementById("chatSection").style.display = "none";
          showFeedback(data.feedback);
        }
      } catch (err) {
        showError("Feedback generation failed");
      }
    }

    /* keep all your helper functions unchanged: addMessage, showTyping, showFeedback,
       endInterview, restartInterview, downloadFeedback, showLoading, updateProgress, etc. */
  </script>
</body>
</html>
